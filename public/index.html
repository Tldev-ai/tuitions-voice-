<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iiTuitions — Voice (HTTPS mode)</title>
  <style>
    :root{ --ink:#000; --ring:#e5e7eb; --idle:#bbb; }
    *{box-sizing:border-box}
    body{ margin:0; color:var(--ink); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
      background:linear-gradient(180deg,#9EC3F2 0%,#DCE7F7 100%); min-height:100vh; }
    .top{ display:flex;align-items:center;gap:10px; border-bottom:1px solid var(--ring);
      padding:12px 16px; background:#ffffffcc; backdrop-filter:saturate(120%) blur(6px); }
    .brand{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--ink);font-weight:800}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .card{padding:24px;border:1px solid var(--ring);border-radius:16px;box-shadow:0 6px 28px rgba(0,0,0,.06);background:#fff}
    h1{margin:0 0 10px} p{margin:0 0 14px}
    .sub{margin:-6px 0 14px;font-weight:600} .muted{opacity:.9}
    .consent{display:flex;align-items:center;gap:8px;margin-top:10px}
    .row{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
    button{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:12px 16px;border-radius:999px;border:0;
      background:#000;color:#fff;font-weight:800;cursor:pointer;letter-spacing:.2px}
    #startBtn{min-width:320px;padding:14px 36px;font-size:18px}
    button.end{background:#000;color:#fff;border:2px solid #000} button:disabled{opacity:.6;cursor:not-allowed}
    .fine{font-size:12px;margin-top:8px}
    .led{width:10px;height:10px;border-radius:999px;background:var(--idle);box-shadow:0 0 0 1px #0001}
    .led.on{background:#000}
    audio{display:none}
  </style>
</head>
<body>
  <header class="top">
    <a class="brand" href="#"><img src="/assets/iituitions-logo.png" alt="logo" style="height:24px"> iiTuitions</a>
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Talk to our Admissions Assistant</h1>
      <p class="sub muted">Works behind any firewall — no WebRTC.</p>

      <label class="consent">
        <input type="checkbox" id="consent" />
        I agree to the recording and storage of this conversation.
      </label>

      <div class="row">
        <button id="startBtn">Start Voice</button>
        <button id="endBtn" class="end" disabled>End</button>
        <span class="led" id="led" title="Mic activity"></span>
        <audio id="aiAudio" autoplay playsinline></audio>
      </div>

      <p class="fine">Say “Switch to Telugu” or “Switch to Hindi” anytime.</p>
    </section>
  </main>

  <script>
    // ====== Simple voice bot over HTTPS (no WebRTC) ======
    const consent = document.getElementById('consent');
    const startBtn = document.getElementById('startBtn');
    const endBtn = document.getElementById('endBtn');
    const led = document.getElementById('led');
    const aiAudio = document.getElementById('aiAudio');

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog, recTimer;
    let running = false;
    let lang = 'en';              // 'en' | 'hi' | 'te'
    let langToBCP47 = { en: 'en-IN', hi: 'hi-IN', te: 'te-IN' };
    let history = [];

    function timeOfDay(){ const h=new Date().getHours(); return h<12?'morning':h<17?'afternoon':'evening'; }

    function speakLocal(text, bcp47){
      return new Promise(async (resolve) => {
        // Prefer native speech synthesis
        if ('speechSynthesis' in window) {
          const u = new SpeechSynthesisUtterance(text);
          u.lang = bcp47 || 'en-IN';
          u.rate = 1; u.pitch = 1;
          u.onend = resolve;
          speechSynthesis.speak(u);
          return;
        }
        // Fallback to server TTS (MP3)
        try {
          const r = await fetch('/api/tts', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ text, voice: 'verse' })
          });
          const blob = await r.blob();
          aiAudio.src = URL.createObjectURL(blob);
          aiAudio.onended = resolve;
          aiAudio.play().catch(()=>resolve());
        } catch { resolve(); }
      });
    }

    function detectSwitch(text){
      const t = text.toLowerCase();
      if (t.includes('switch to telugu') || t.includes('telugu')) return 'te';
      if (t.includes('switch to hindi')  || t.includes('hindi'))  return 'hi';
      if (t.includes('switch to english')|| t.includes('english'))return 'en';
      return null;
    }

    function startRecog(){
      if (!SR) { alert('Your browser lacks SpeechRecognition. Use Chrome desktop or provide TTS only.'); return; }
      if (recog) { try{ recog.abort(); }catch{} }
      recog = new SR();
      recog.lang = langToBCP47[lang] || 'en-IN';
      recog.interimResults = false;
      recog.continuous = false;

      recog.onstart = () => { led.classList.add('on'); kickSilenceTimer(); };
      recog.onend = () => { led.classList.remove('on'); if (running) kickSilenceTimer(true); };
      recog.onerror = () => { led.classList.remove('on'); if (running) kickSilenceTimer(true); };

      recog.onresult = async (e) => {
        clearTimeout(recTimer);
        const spoken = (e.results[0] && e.results[0][0] && e.results[0][0].transcript) || '';
        // language switch?
        const sw = detectSwitch(spoken);
        if (sw && sw !== lang) {
          lang = sw;
          await speakLocal(lang==='en' ? 'Okay, I will continue in English.'
              : lang==='hi' ? 'ठीक है, मैं अब हिन्दी में बात करूंगा।'
              : 'సరే, ఇప్పటి నుంచి తెలుగు లో మాట్లాడుతాను.', langToBCP47[lang]);
        } else {
          await sendToChat(spoken);
        }
        if (running) startRecog();
      };

      recog.start();
    }

    async function sendToChat(userText){
      history.push({ role:'user', content:userText });
      // call server
      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ history, lang })
      });
      const j = await r.json();
      const bot = j.text || '…';
      history.push({ role:'assistant', content:bot });
      await speakLocal(bot, langToBCP47[lang]);
    }

    function kickSilenceTimer(restart=false){
      clearTimeout(recTimer);
      recTimer = setTimeout(async () => {
        if (!running) return;
        await speakLocal(
          lang==='en' ? "Sorry, I can't hear you. I'll end this call now."
          : lang==='hi' ? "माफ़ कीजिए, आपकी आवाज़ नहीं आ रही है। अब मैं कॉल समाप्त कर रहा हूँ।"
          : "క్షమించండి, నేను వినలేకపోతున్నాను. ఇప్పుడు కాల్ ముగిస్తున్నాను.",
          langToBCP47[lang]
        );
        stopAll();
      }, 10000);
      if (restart && SR) setTimeout(()=>recog && recog.start(), 150); // auto-retry
    }

    async function startAll(){
      if (!consent.checked) { alert('Please agree to the recording notice.'); return; }
      running = true; startBtn.disabled = true; endBtn.disabled = false;

      // greeting
      await speakLocal(
        lang==='en' ? `Hai. Good ${timeOfDay()}. Which language would you like to talk in — English, Telugu, or Hindi?`
        : lang==='hi' ? `हाय। शुभ ${timeOfDay()==='morning'?'सुबह':'शाम'}. आप किस भाषा में बात करना चाहेंगे — English, हिंदी या तेलुगु?`
        : `హాయ్. శుభ ${timeOfDay()==='morning'?'ఉదయం':'సాయంత్రం'}. మీరు ఏ భాషలో మాట్లాడాలనుకుంటున్నారు — ఇంగ్లీష్, తెలుగు లేదా హిందీ?`,
        langToBCP47[lang]
      );

      startRecog();
    }

    function stopAll(){
      running = false; startBtn.disabled = false; endBtn.disabled = true;
      try { clearTimeout(recTimer); } catch {}
      try { recog && recog.abort(); } catch {}
      led.classList.remove('on');
    }

    startBtn.addEventListener('click', startAll);
    endBtn.addEventListener('click', stopAll);
  </script>
</body>
</html>
